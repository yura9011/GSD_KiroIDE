#!/bin/bash
# .git/hooks/post-commit
# Automatic codebase intelligence update after each commit
# 
# Installation:
#   cp scripts/hooks/post-commit .git/hooks/
#   chmod +x .git/hooks/post-commit

# Configuration
INTEL_DIR=".gsd/intel"
QUIET=true

# Check if intelligence directory exists
if [ ! -d "$INTEL_DIR" ]; then
  # Intelligence not initialized, skip
  exit 0
fi

# Run incremental indexing
if [ "$QUIET" = true ]; then
  ./scripts/index-codebase.sh --incremental > /dev/null 2>&1
else
  echo "Updating codebase intelligence..."
  ./scripts/index-codebase.sh --incremental
fi

# Check if intelligence changed
if git diff --quiet "$INTEL_DIR"; then
  # No changes, exit
  exit 0
fi

# Intelligence changed, amend commit to include it
git add "$INTEL_DIR"
git commit --amend --no-edit --no-verify

if [ "$QUIET" = false ]; then
  echo "Codebase intelligence updated and included in commit"
fi

exit 0
